
# Incident Report & AI Handover (2025-12-14)

## 1. 字幕タイムスタンプ問題の解決

### 概要
動画の字幕データのタイムスタンプがすべて「0:00」と表示される、あるいは字幕自体が表示されない問題が発生していた。

### 原因
1.  **しきい値判定ロジックの不備**: 以前のAI (Claude) が導入した「10秒しきい値判定」が、短いセグメントや開始時間の早いセグメントを不正にはじいていた。
2.  **データ構造の不整合**: `youtubei.js` から返されるオブジェクトがクラスインスタンスであり、単純なプロパティアクセスで値が取れない場合があった。
3.  **JSONデータの二重化**: DB保存時または取得時の処理により、`transcript.segments` が「JSON文字列をさらにJSON文字列化したもの」として保存されていたケースがあり、パースしても配列ではなく文字列が返ってくる状態だった。

### 修正内容
- **Antigravity (Gemini 1.5 Pro)** により修正完了。
- **ロジック刷新**: 「10秒ルール」を廃止し、`startMs`, `startTimeMs` など多岐にわたるプロパティ名を厳密にチェックするロジックに変更 (`src/lib/transcript-utils.ts`)。
- **データ正規化**: 生データを一度 `JSON.parse(JSON.stringify(raw))` することでPlain Object化し、安定したプロパティアクセスを保証。
- **DBデータ確認**: 二重文字列化の可能性を考慮し、APIやクライアント側でのパース処理を堅牢化（現在はインポート処理が正常化したため、新規データは正しいJSON配列として保存される）。

## 2. 動画削除機能の実装とUI修正

### 概要
ダッシュボードおよび学習画面から動画を削除しようとしても、ポップアップが一瞬で消える、あるいは何も起こらないという報告があった。

### 原因
1.  **APIエンドポイントの欠如**: `DELETE /api/videos/[id]` が未実装だった。
2.  **イベントの競合**: ダッシュボードの動画カード全体が `<Link>` でラップされており、削除ボタンのクリックイベントがページ遷移イベントと競合・干渉していた。
3.  **`window.confirm` の自動キャンセル**: ブラウザ環境やNext.jsのルーター遷移との兼ね合いで、`confirm` ダイアログが即座に閉じられてしまっていた。

### 修正内容
- **API実装**: `src/app/api/videos/[id]/route.ts` を作成し、削除ロジックを実装。
- **UI構造変更 (Dashboard)**: `<Link>` ラッパーを廃止し、`div` + `onClick` (router.push) に変更。削除ボタンを独立させ、イベント伝播 (`stopPropagation`) を防止。
- **UX変更**: 学習画面 (`LearnClient`) およびダッシュボード画面 (`DashboardClient`) において、不安定な `window.confirm` を廃止。ワンクリックで即時削除・遷移する仕様に変更。

---

## 🤖 Future AI Instructions (AIへの申し送り事項)

1.  **タイムスタンプ判定ロジックの変更禁止**:
    タイムスタンプ取得ロジック (`src/lib/transcript-utils.ts`) は現在、多様なデータ形式に対応して安定稼働している。**「推測ベースの判定」や「恣意的なしきい値（例：10秒以下は無視など）」を再導入してはならない。** 修正が必要な場合は、現在の厳密なプロパティチェック方式を継承すること。

2.  **イベントハンドリングの注意**:
    Next.js の App Router (`next/navigation`) 環境下において、ネストされたインタラクティブ要素（カード内のボタンなど）を作る際は、`<Link>` コンポーネントで全体を囲むのではなく、独立した要素として配置し、親要素のクリックハンドリングと明確に分離すること。

3.  **確認ダイアログの扱い**:
    現在の環境では `window.confirm` が不安定であるため、重要なアクション（削除など）には独自のモーダルを使用するか、あるいは今回の対応のように「即時実行」とし、必要であればUndo機能などを検討すること。安易に `alert` や `confirm` に頼らない。
